generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// -----------CORE ENTITIES----------

model Company {
  id        String   @id @default(uuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  users           User[]
  departments     Department[]
  designations    Designation[]
  employees       EmployeeProfile[]
  attendanceDays  AttendanceDay[]
  officeLocations OfficeLocation[]

  holidays      Holiday[]
  leaveTypes    LeaveType[]
  leavePolicies LeavePolicy[]

  attendanceViolations  AttendanceViolation[]
  logGeoFenceViolations Boolean               @default(false)

  designationAttendancePolicies DesignationAttendancePolicy[]
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  personalEmail String?
  passwordHash  String?
  authProvider  AuthProvider
  providerId    String?
  isActive      Boolean      @default(true)

  role UserRole @default(EMPLOYEE)

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  employee EmployeeProfile?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  refreshTokens RefreshToken[]

  @@index([companyId])
}

// ---------ORGANIZATION-----------

model Department {
  id        String  @id @default(uuid())
  name      String
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  isActive  Boolean @default(true)
  teams     Team[]

  createdAt DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model Team {
  id           String            @id @default(uuid())
  name         String
  departmentId String
  department   Department        @relation(fields: [departmentId], references: [id])
  isActive     Boolean           @default(true)
  employees    EmployeeProfile[]

  createdAt DateTime @default(now())

  @@unique([departmentId, name])
}

model Designation {
  id               String                       @id @default(uuid())
  name             String
  companyId        String
  company          Company                      @relation(fields: [companyId], references: [id])
  isActive         Boolean                      @default(true)
  employees        EmployeeProfile[]
  attendancePolicy DesignationAttendancePolicy?

  createdAt DateTime @default(now())

  @@unique([companyId, name])
}

model DesignationAttendancePolicy {
  id String @id @default(uuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  designationId String      @unique
  designation   Designation @relation(fields: [designationId], references: [id])

  autoPresent      Boolean @default(false)
  attendanceExempt Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

// ----------EMPLOYEE-----------

model EmployeeProfile {
  id String @id @default(uuid())

  employeeCode Int

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  designationId String
  designation   Designation @relation(fields: [designationId], references: [id])
  teamId        String?
  team          Team?       @relation(fields: [teamId], references: [id])

  managerId    String?
  manager      EmployeeProfile?  @relation("ManagerRelation", fields: [managerId], references: [id])
  subordinates EmployeeProfile[] @relation("ManagerRelation")

  firstName   String
  middleName  String?
  lastName    String
  displayName String

  isActive    Boolean  @default(true)
  isProbation Boolean  @default(true)
  joiningDate DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendanceDays              AttendanceDay[]
  attendanceViolations        AttendanceViolation[]
  employeeAttendanceOverrides EmployeeAttendanceOverride[]
  leaveBalances               LeaveBalance[]
  leaveRequests               LeaveRequest[]               @relation("LeaveApplicant")
  approvedLeaveRequests       LeaveRequest[]               @relation("LeaveApprover")
  leaveEncashments            LeaveEncashment[]
  employeeLeaveOverrides      EmployeeLeaveOverride[]

  @@unique([companyId, employeeCode])
  @@index([companyId])
  @@index([managerId])
}

// -----ATTENDANCE-----

model AttendanceDay {
  id String @id @default(uuid())

  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  date DateTime

  status       AttendanceStatus @default(ABSENT)
  totalMinutes Int              @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events AttendanceEvent[]

  @@unique([employeeId, date])
  @@index([companyId, date])
}

model AttendanceEvent {
  id String @id @default(uuid())

  attendanceDayId String
  attendanceDay   AttendanceDay @relation(fields: [attendanceDayId], references: [id])

  type      AttendanceEventType
  timestamp DateTime

  source AttendanceSource

  createdAt DateTime @default(now())

  @@index([attendanceDayId])
}

// --------AttendanceViolation-------

model AttendanceViolation {
  id String @id @default(uuid())

  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  latitude  Float
  longitude Float
  distanceM Float

  reason String // OUTSIDE_RADIUS | NO_OFFICE_CONFIG
  source AttendanceSource

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([employeeId])
}

model EmployeeAttendanceOverride {
  id String @id @default(uuid())

  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  autoPresent      Boolean @default(false)
  attendanceExempt Boolean @default(false)

  reason String? // Offer letter / contract note

  validFrom DateTime
  validTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
}

// --------Office Location---------

model OfficeLocation {
  id String @id @default(uuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  latitude  Float
  longitude Float
  radiusM   Int // radius in meters

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

// ----------CompanyDefined Leave Types------------
model LeaveType {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name     String // Casual Leave
  code     String // CL
  isPaid   Boolean @default(true)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  policies               LeavePolicy[]
  balances               LeaveBalance[]
  requests               LeaveRequest[]
  leaveEncashments       LeaveEncashment[]
  employeeLeaveOverrides EmployeeLeaveOverride[]

  @@unique([companyId, code])
  @@index([companyId])
}

// -----Leave Policy--------
model LeavePolicy {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  leaveTypeId String
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])

  year Int

  yearlyAllocation Float

  allowCarryForward Boolean @default(false)
  maxCarryForward   Int?

  allowEncashment  Boolean @default(false)
  probationAllowed Boolean @default(false)

  genderRestriction GenderRestriction?

  monthlyAccrual Boolean @default(false)

  sandwichRule Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([leaveTypeId, year])
  @@index([companyId, year])
}

// --------Leave Balance -------------
model LeaveBalance {
  id String @id @default(uuid())

  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  leaveTypeId String
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])

  year Int

  allocated      Float
  used           Float @default(0)
  carriedForward Float @default(0)
  remaining      Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, leaveTypeId, year])
  @@index([employeeId, year])
}

// -------Leave Request-------------
model LeaveRequest {
  id String @id @default(uuid())

  employeeId String
  employee   EmployeeProfile @relation("LeaveApplicant", fields: [employeeId], references: [id])

  leaveTypeId String
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])

  fromDate DateTime
  toDate   DateTime

  durationType  LeaveDurationType
  durationValue Float

  reason String?

  status LeaveRequestStatus @default(PENDING)

  approvedById String?
  approvedBy   EmployeeProfile? @relation("LeaveApprover", fields: [approvedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
}

// -----Leave Encashment---------
model LeaveEncashment {
  id String @id @default(uuid())

  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  leaveTypeId String
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])

  year Int
  days Float

  status LeaveEncashmentStatus @default(REQUESTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, year])
}

//-------- Employee Leave Overide byHR-------------
model EmployeeLeaveOverride {
  id String @id @default(uuid())

  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  leaveTypeId String
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])

  year Int

  allowSandwich   Boolean?
  allowEncashment Boolean?
  extraAllocation Float?

  reason String?

  createdAt DateTime @default(now())

  @@unique([employeeId, leaveTypeId, year])
}

//------ Holiday Calendar CompanyWise-------
model Holiday {
  id String @id @default(uuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name String
  date DateTime

  createdAt DateTime @default(now())

  @@unique([companyId, date])
  @@index([companyId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userAgent String?
  ipAddress String?

  @@index([userId, expiresAt])
}

// ---------ENUMS------

enum AuthProvider {
  LOCAL
  GOOGLE
  MICROSOFT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  PARTIAL
  LEAVE
}

enum AttendanceEventType {
  CHECK_IN
  CHECK_OUT
}

enum AttendanceSource {
  WEB
  PWA
}

enum LeaveDurationType {
  FULL_DAY
  HALF_DAY
  QUARTER_DAY
  HOURLY
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveEncashmentStatus {
  REQUESTED
  APPROVED
  REJECTED
}

enum GenderRestriction {
  MALE
  FEMALE
  OTHER
}

enum UserRole {
  SUPER_ADMIN
  COMPANY_ADMIN
  HR
  EMPLOYEE
}
