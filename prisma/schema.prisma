generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// -----------CORE ENTITIES----------

model Company {
  id        String   @id @default(uuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  users        User[]
  departments  Department[]
  designations Designation[]
  employees    EmployeeProfile[]
  attendanceDays AttendanceDay[]
  officeLocations OfficeLocation[]

}

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  passwordHash  String?
  authProvider  AuthProvider
  providerId    String?
  isActive      Boolean      @default(true)

  companyId     String
  company       Company      @relation(fields: [companyId], references: [id])

  employee      EmployeeProfile?

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([companyId])
}

// ---------ORGANIZATION-----------

model Department {
  id        String   @id @default(uuid())
  name      String
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])

  teams     Team[]

  createdAt DateTime @default(now())

  @@unique([companyId, name])
  @@index([companyId])
}

model Team {
  id           String   @id @default(uuid())
  name         String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  employees    EmployeeProfile[]

  createdAt    DateTime @default(now())

  @@unique([departmentId, name])
}

model Designation {
  id        String   @id @default(uuid())
  name      String
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])

  employees EmployeeProfile[]

  createdAt DateTime @default(now())

  @@unique([companyId, name])
}


// ----------EMPLOYEE-----------


model EmployeeProfile {
  id             String   @id @default(uuid())
  
  employeeCode   Int
  
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])

  companyId      String
  company        Company  @relation(fields: [companyId], references: [id])

  designationId  String
  designation    Designation @relation(fields: [designationId], references: [id])

  teamId         String
  team           Team     @relation(fields: [teamId], references: [id])

  managerId      String?
  manager        EmployeeProfile? @relation("ManagerRelation", fields: [managerId], references: [id])
  subordinates   EmployeeProfile[] @relation("ManagerRelation")
  
  firstName      String
  middleName     String?
  lastName       String
  displayName    String
  
  isProbation    Boolean  @default(true)
  joiningDate    DateTime

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  attendanceDays AttendanceDay[]

  @@unique([companyId, employeeCode])
  @@index([companyId])
  @@index([managerId])
}

// -----ATTENDANCE-----

model AttendanceDay {
  id             String   @id @default(uuid())

  employeeId     String
  employee       EmployeeProfile @relation(fields: [employeeId], references: [id])

  companyId      String
  company        Company  @relation(fields: [companyId], references: [id])

  date           DateTime

  status         AttendanceStatus @default(ABSENT)
  totalMinutes   Int      @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  events         AttendanceEvent[]

  @@unique([employeeId, date])
  @@index([companyId, date])
}

model AttendanceEvent {
  id              String   @id @default(uuid())

  attendanceDayId String
  attendanceDay   AttendanceDay @relation(fields: [attendanceDayId], references: [id])

  type            AttendanceEventType
  timestamp       DateTime

  source          AttendanceSource

  createdAt       DateTime @default(now())

  @@index([attendanceDayId])
}

// --------Office Location---------

model OfficeLocation {
  id        String   @id @default(uuid())

  companyId String
  company   Company  @relation(fields: [companyId], references: [id])

  latitude  Float
  longitude Float
  radiusM   Int      // radius in meters

  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}


// ---------ENUMS------


enum AuthProvider {
  LOCAL
  GOOGLE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  PARTIAL
}

enum AttendanceEventType {
  CHECK_IN
  CHECK_OUT
}

enum AttendanceSource {
  WEB
  PWA
}